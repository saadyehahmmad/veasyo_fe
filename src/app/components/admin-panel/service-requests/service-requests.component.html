<div class="tab-content">
  <mat-card class="data-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>room_service</mat-icon>
        {{ 'admin.serviceRequests.title' | translate }}
      </mat-card-title>
      <mat-card-subtitle>{{ 'admin.serviceRequests.subtitle' | translate }}</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <!-- Filters -->
      <div class="filters-section">
        <div class="filters-header">
          <h3>{{ 'admin.serviceRequests.filters' | translate }}</h3>
        </div>

        <form [formGroup]="filterForm" class="filters-form">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'admin.serviceRequests.status' | translate }}</mat-label>
            <mat-select formControlName="status">
              @for (option of statusOptions; track option.value) {
                <mat-option [value]="option.value">
                  @if (option.value) {
                    <mat-icon [style.color]="getStatusColor(option.value)">{{
                      getStatusIcon(option.value)
                    }}</mat-icon>
                  }
                  {{ option.label }}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'admin.serviceRequests.type' | translate }}</mat-label>
            <mat-select formControlName="type">
              @for (option of typeOptions; track option.value) {
                <mat-option [value]="option.value">
                  @if (option.value) {
                    <mat-icon>{{ getTypeIcon(option.value) }}</mat-icon>
                  }
                  {{ option.label }}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>

          <div class="filter-actions">
            <button mat-button color="primary" (click)="clearFilters()">
              <mat-icon>clear_all</mat-icon>
              {{ 'admin.serviceRequests.clearAll' | translate }}
            </button>
            <button mat-stroked-button type="button" (click)="loadServiceRequests()">
              {{ 'admin.serviceRequests.refresh' | translate }}
              <mat-icon>refresh</mat-icon>
            </button>
          </div>
        </form>
      </div>

      <!-- Loading State -->
      @if (loading()) {
        <div class="loading-state">
          <mat-spinner diameter="50"></mat-spinner>
          <div class="loading-text">
            <h4>{{ 'admin.serviceRequests.loadingRequests' | translate }}</h4>
            <p>{{ 'admin.serviceRequests.loadingMessage' | translate }}</p>
          </div>
        </div>
      }

      <!-- Data Table -->
      @if (!loading() && totalCount() > 0) {
        <div class="table-container">
        <table mat-table [dataSource]="dataSource" class="data-table">
          <ng-container matColumnDef="tableName">
            <th mat-header-cell *matHeaderCellDef>
              <button
                class="sort-button"
                (click)="toggleSort('tableNumber')"
                [class.active]="sortBy() === 'tableNumber'"
              >
                <mat-icon>table_restaurant</mat-icon>
                {{ 'admin.serviceRequests.tableName' | translate }}
                <mat-icon class="sort-icon">{{ getSortIcon('tableNumber') }}</mat-icon>
              </button>
            </th>
            <td mat-cell *matCellDef="let request" class="table-cell">
              <div class="table-info">
                <mat-icon>table_restaurant</mat-icon>
                <span class="table-number">{{ request.tableNumber || 'N/A' }}</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="acknowledgedBy">
            <th mat-header-cell *matHeaderCellDef>
              <mat-icon>person</mat-icon>
              {{ 'admin.serviceRequests.acknowledgedBy' | translate }}
            </th>
            <td mat-cell *matCellDef="let request" class="user-cell">
              @if (request.acknowledgedByUser) {
                <div class="user-info">
                  <mat-icon>person</mat-icon>
                  <span>{{ getAcknowledgedBy(request) }}</span>
                </div>
              } @else {
                <span class="not-acknowledged">
                  <mat-icon>schedule</mat-icon>
                  {{ 'admin.serviceRequests.pending' | translate }}
                </span>
              }
            </td>
          </ng-container>

          <ng-container matColumnDef="completedBy">
            <th mat-header-cell *matHeaderCellDef>
              <mat-icon>how_to_reg</mat-icon>
              {{ 'admin.serviceRequests.completedBy' | translate }}
            </th>
            <td mat-cell *matCellDef="let request" class="completed-by-cell">
              @if (request.status === 'completed' && request.completedBy) {
                <mat-chip [color]="getCompletedByColor(request.completedBy)" class="completed-by-chip">
                  <mat-icon>{{ getCompletedByIcon(request.completedBy) }}</mat-icon>
                  {{ getCompletedBy(request) }}
                </mat-chip>
              } @else if (request.status === 'completed') {
                <mat-chip color="basic" class="completed-by-chip">
                  <mat-icon>help_outline</mat-icon>
                  Unknown
                </mat-chip>
              } @else {
                <span class="not-completed">—</span>
              }
            </td>
          </ng-container>

          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef>
              <button
                class="sort-button"
                (click)="toggleSort('timestampCreated')"
                [class.active]="sortBy() === 'timestampCreated'"
              >
                <mat-icon>event</mat-icon>
                {{ 'admin.serviceRequests.createdAt' | translate }}
                <mat-icon class="sort-icon">{{ getSortIcon('timestampCreated') }}</mat-icon>
              </button>
            </th>
            <td mat-cell *matCellDef="let request" class="date-cell">
              <div class="date-info">
                <mat-icon>event</mat-icon>
                <span class="date-text">{{ formatDate(request.timestampCreated) }}</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="duration">
            <th mat-header-cell *matHeaderCellDef>
              <button
                class="sort-button"
                (click)="toggleSort('durationSeconds')"
                [class.active]="sortBy() === 'durationSeconds'"
              >
                <mat-icon>schedule</mat-icon>
                {{ 'admin.serviceRequests.duration' | translate }}
                <mat-icon class="sort-icon">{{ getSortIcon('durationSeconds') }}</mat-icon>
              </button>
            </th>
            <td mat-cell *matCellDef="let request" class="duration-cell">
              <div class="duration-info">
                <mat-icon>schedule</mat-icon>
                <span class="duration-text">{{ formatDuration(request) }}</span>
              </div>
            </td>
          </ng-container>

          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef>
              <button
                class="sort-button"
                (click)="toggleSort('requestType')"
                [class.active]="sortBy() === 'requestType'"
              >
                <mat-icon>category</mat-icon>
                {{ 'admin.serviceRequests.type' | translate }}
                <mat-icon class="sort-icon">{{ getSortIcon('requestType') }}</mat-icon>
              </button>
            </th>
            <td mat-cell *matCellDef="let request" class="type-cell">
              <mat-chip [color]="getTypeColor(request.requestType)" class="type-chip">
                <mat-icon>{{ getTypeIcon(request) }}</mat-icon>
                {{ getTypeLabel(request) }}
              </mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>
              <button
                class="sort-button"
                (click)="toggleSort('status')"
                [class.active]="sortBy() === 'status'"
              >
                <mat-icon>info</mat-icon>
                {{ 'admin.serviceRequests.status' | translate }}
                <mat-icon class="sort-icon">{{ getSortIcon('status') }}</mat-icon>
              </button>
            </th>
            <td mat-cell *matCellDef="let request" class="status-cell">
              <mat-chip [color]="getStatusColor(request.status)" class="status-chip">
                <mat-icon>{{ getStatusIcon(request.status) }}</mat-icon>
                {{ request.status | titlecase }}
              </mat-chip>
            </td>
          </ng-container>

          <ng-container matColumnDef="feedback">
            <th mat-header-cell *matHeaderCellDef>
              <mat-icon>star</mat-icon>
              {{ 'admin.serviceRequests.feedback' | translate }}
            </th>
            <td mat-cell *matCellDef="let request" class="feedback-cell">
              @if (hasFeedback(request)) {
                <div class="feedback-info clickable" (click)="showFeedbackDetails(request)">
                  <div class="stars-rating">
                    <span class="stars">{{ getFeedbackStars(request.feedbackRating) }}</span>
                    <span class="rating-number">({{ request.feedbackRating }}/5)</span>
                  </div>
                  <div class="feedback-icons">
                    @if (request.feedbackComments) {
                      <mat-icon class="comment-icon">comment</mat-icon>
                    }
                    @if (request.feedbackCustomerName) {
                      <mat-icon class="contact-icon">person</mat-icon>
                    }
                  </div>
                </div>
              } @else {
                <span class="no-feedback">—</span>
              }
            </td>
          </ng-container>

          <ng-container matColumnDef="action">
            <th mat-header-cell *matHeaderCellDef>
              <mat-icon>build</mat-icon>
              {{ 'admin.serviceRequests.actions' | translate }}
            </th>
            <td mat-cell *matCellDef="let request" class="action-cell">
              <div class="action-buttons">
                @if (request.status === 'pending') {
                  <button
                    mat-icon-button
                    color="primary"
                    (click)="updateRequestStatus(request.id, 'acknowledged', 'admin')"
                    [matTooltip]="'admin.serviceRequests.acknowledgeRequest' | translate"
                    class="action-btn acknowledge"
                  >
                    <mat-icon>check_circle</mat-icon>
                  </button>
                }
                @if (request.status === 'acknowledged') {
                  <button
                    mat-icon-button
                    color="accent"
                    (click)="updateRequestStatus(request.id, 'completed')"
                    [matTooltip]="'admin.serviceRequests.markCompleted' | translate"
                    class="action-btn complete"
                  >
                    <mat-icon>done_all</mat-icon>
                  </button>
                }
                <button
                  mat-icon-button
                  color="warn"
                  (click)="deleteServiceRequest(request.id)"
                  [matTooltip]="'admin.serviceRequests.deleteRequest' | translate"
                  class="action-btn delete"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="requestColumns" class="table-header"></tr>
          <tr mat-row *matRowDef="let row; columns: requestColumns" class="table-row"></tr>
        </table>
        </div>
      }

      <!-- Empty State -->
      @if (!loading() && totalCount() === 0) {
        <div class="empty-state">
        <mat-icon class="empty-icon">room_service</mat-icon>
        <h3>{{ 'admin.serviceRequests.noRequests' | translate }}</h3>
        <p>{{ 'admin.serviceRequests.noRequestsMessage' | translate }}</p>
        <button mat-raised-button color="primary" (click)="clearFilters()">
          <mat-icon>clear_all</mat-icon>
          {{ 'admin.serviceRequests.clearFilters' | translate }}
        </button>
      </div>
      }

      <!-- Simplified Pagination -->
      @if (!loading() && totalCount() > 0) {
        <div class="pagination-section">
        <div class="pagination-info">
          <span class="results-range">
            {{ 'admin.serviceRequests.showing' | translate }} {{ (currentPage() - 1) * pageSize() + 1 }} - {{ getPageEnd() }} {{ 'admin.serviceRequests.of' | translate }}
            {{ totalCount() }} {{ 'admin.serviceRequests.requests' | translate }}
          </span>
        </div>

        <div class="pagination-controls">
          <mat-form-field appearance="outline" class="page-size-selector">
            <mat-label>{{ 'admin.serviceRequests.itemsPerPage' | translate }}</mat-label>
            <mat-select [value]="pageSize()" (selectionChange)="changePageSize($event.value)">
              <mat-option [value]="5">5</mat-option>
              <mat-option [value]="10">10</mat-option>
              <mat-option [value]="20">20</mat-option>
              <mat-option [value]="50">50</mat-option>
            </mat-select>
          </mat-form-field>

          <div class="page-navigation">
            <button
              mat-icon-button
              [disabled]="!hasPrev()"
              (click)="prevPage()"
              [matTooltip]="'admin.serviceRequests.previousPage' | translate"
              class="nav-btn"
            >
              <mat-icon>chevron_left</mat-icon>
            </button>

            <span class="page-indicator"> {{ 'admin.serviceRequests.page' | translate }} {{ currentPage() }} {{ 'admin.serviceRequests.of' | translate }} {{ totalPages() }} </span>

            <button
              mat-icon-button
              [disabled]="!hasNext()"
              (click)="nextPage()"
              [matTooltip]="'admin.serviceRequests.nextPage' | translate"
              class="nav-btn"
            >
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>
        </div>
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>

<!-- Feedback Details Dialog -->
@if (selectedFeedback()) {
  <div class="feedback-dialog-overlay" (click)="closeFeedbackDetails()">
    <div class="feedback-dialog" (click)="$event.stopPropagation()">
      <div class="feedback-dialog-header">
        <h2>
          <mat-icon>star</mat-icon>
          Customer Feedback
        </h2>
        <button mat-icon-button (click)="closeFeedbackDetails()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      
      <div class="feedback-dialog-content">
        <!-- Rating -->
        <div class="feedback-section">
          <h3>Rating</h3>
          <div class="rating-display">
            <span class="stars-large">{{ getFeedbackStars(selectedFeedback()!.feedbackRating) }}</span>
            <span class="rating-text">{{ selectedFeedback()!.feedbackRating }} out of 5 stars</span>
          </div>
        </div>

        <!-- Comments -->
        @if (selectedFeedback()!.feedbackComments) {
          <div class="feedback-section">
            <h3>
              <mat-icon>comment</mat-icon>
              Comments
            </h3>
            <p class="feedback-text">{{ selectedFeedback()!.feedbackComments }}</p>
          </div>
        }

        <!-- Customer Info -->
        @if (selectedFeedback()!.feedbackCustomerName || selectedFeedback()!.feedbackCustomerPhone) {
          <div class="feedback-section">
            <h3>
              <mat-icon>person</mat-icon>
              Customer Information
            </h3>
            <div class="customer-info">
              @if (selectedFeedback()!.feedbackCustomerName) {
                <div class="info-row">
                  <mat-icon>badge</mat-icon>
                  <span>{{ selectedFeedback()!.feedbackCustomerName }}</span>
                </div>
              }
              @if (selectedFeedback()!.feedbackCustomerPhone) {
                <div class="info-row">
                  <mat-icon>phone</mat-icon>
                  <span>{{ selectedFeedback()!.feedbackCustomerPhone }}</span>
                </div>
              }
            </div>
          </div>
        }

        <!-- Request Info -->
        <div class="feedback-section">
          <h3>
            <mat-icon>info</mat-icon>
            Request Details
          </h3>
          <div class="request-info">
            <div class="info-row">
              <mat-icon>table_restaurant</mat-icon>
              <span>Table: {{ selectedFeedback()!.tableNumber }}</span>
            </div>
            <div class="info-row">
              <mat-icon>schedule</mat-icon>
              <span>{{ selectedFeedback()!.timestampCreated | date: 'medium' }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
}
